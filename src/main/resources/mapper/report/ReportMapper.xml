<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.pcwk.ehr.mapper.ReportMapper">

    <insert id="doSave" parameterType="ReportVO">
        <selectKey keyProperty="reportSid" order="BEFORE" resultType="int">
            SELECT REPORT_SEQ.NEXTVAL FROM DUAL
        </selectKey>

        INSERT INTO REPORT
        (REPORT_SID,
         REPORT_CONTENT,
         REPORT_CATEGORY,
         FAMOUS_SID,
         COMMENT_SID,
         DIARY_SID,
         REG_ID)
        VALUES (
            #{reportSid},
            #{reportContent},
            #{reportCategory},
            <choose>
                <when test="famousSid != null">
                    #{famousSid}, NULL, NULL
                </when>
                <when test="commentSid != null">
                    NULL, #{commentSid}, NULL
                </when>
                <when test="diarySid != null">
                    NULL, NULL, #{diarySid}
                </when>
                <otherwise>
                    NULL, NULL, NULL
                </otherwise>
            </choose>,
            #{regId}
        )
    </insert>

    <delete id ="deleteAll">
    DELETE FROM report
    </delete>

    <select id="getCount" resultType="int">
        SELECT COUNT(*) FROM report
    </select>

    <select id="doSelectOne" parameterType="ReportVO" resultType="ReportVO">
        SELECT report_sid       AS reportSid,
               report_content   AS reportContent,
               report_category  AS reportCategory,
               famous_sid       AS famousSid,
               comment_sid      AS commentSid,
               diary_sid        AS diarySid,
               reg_id           AS regId
        FROM report
        WHERE report_sid = #{reportSid}
    </select>
    
    <delete id="doDelete" parameterType="ReportVO">
        DELETE FROM report
        WHERE report_sid = #{reportSid}
    </delete>


    <select id="doRetrieve" parameterType="com.pcwk.ehr.cmn.DTO" resultType="ReportVO">
    SELECT A.*, B.*
    FROM (
        SELECT tt1.rnum AS no,
               tt1.report_sid,
               tt1.report_content,
               tt1.report_category,
               tt1.famous_sid,
               tt1.comment_sid,
               tt1.diary_sid,
               tt1.reg_id
        FROM (
            SELECT ROWNUM AS rnum, t1.*
            FROM (
                SELECT *
                FROM report
                WHERE 1=1
                ORDER BY report_sid DESC
            ) t1
            WHERE ROWNUM <![CDATA[ <= ]]> (#{pageSize} * (#{pageNo} - 1) + #{pageSize})
        ) tt1
        WHERE tt1.rnum <![CDATA[ >= ]]> (#{pageSize} * (#{pageNo} - 1) + 1)
    ) A
    CROSS JOIN (
        SELECT COUNT(*) total_cnt
        FROM report
        WHERE 1=1
    ) B
</select>

    <insert id="saveAll">
        INSERT INTO REPORT (
            REPORT_SID,
            REPORT_CONTENT,
            REPORT_CATEGORY,
            FAMOUS_SID,
            COMMENT_SID,
            DIARY_SID,
            REG_ID
        )
        SELECT
            REPORT_SEQ.NEXTVAL AS report_sid,
            '신고내용' || ROWNUM AS report_content,
            10 AS report_category,
            NULL AS famous_sid,
            NULL AS comment_sid,
            D.DIARY_SID AS diary_sid,
            'user01' AS reg_id
        FROM DIARY D
        WHERE ROWNUM <![CDATA[ <= ]]> 1002
    </insert>

</mapper>